/*global location */                                                                                                                                                                                                                                           
sap.ui.define([                                                                                                                                                                                                                                                
	"com/mscg/applications/cubiscan/measure/controller/BaseController",                                                                                                                                                                                           
	"sap/ui/model/json/JSONModel",                                                                                                                                                                                                                                
	"com/mscg/applications/cubiscan/measure/model/formatter",                                                                                                                                                                                                     
	'sap/m/Dialog'                                                                                                                                                                                                                                                
], function(BaseController, JSONModel, formatter, Dialog) {                                                                                                                                                                                                    
	"use strict";                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
	return BaseController.extend("com.mscg.applications.cubiscan.measure.controller.Detail", {                                                                                                                                                                    
                                                                                                                                                                                                                                                               
		formatter: formatter,                                                                                                                                                                                                                                        
		_oCubiscanDialog: null,                                                                                                                                                                                                                                      
		_oManualEntryDialog: null,                                                                                                                                                                                                                                   
		_oWebSocket: null,                                                                                                                                                                                                                                           
		_bValidatingProductNumber: false,                                                                                                                                                                                                                            
		_oMessagesDialog: null,                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
		/* =========================================================== */                                                                                                                                                                                            
		/* lifecycle methods                                           */                                                                                                                                                                                            
		/* =========================================================== */                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
		onInit: function() {                                                                                                                                                                                                                                         
			// Subscribe to the Fiori Configuration loaded channel so that once it is complete we can start the web socket connection.                                                                                                                                  
			// Also subscribe to the warehouse number change channel so we can trigger the warehouse dependent functions such as Cubiscan, etc.                                                                                                                         
			var oEventBus = sap.ui.getCore().getEventBus();                                                                                                                                                                                                             
			oEventBus.subscribe("com.mscg.applications.cubiscan.measure.WarehouseNumber", "Changed", this.onWarehouseNumberChange, this);                                                                                                                               
			oEventBus.subscribe("com.mscg.applications.cubiscan.measure.FioriConfiguration", "Loaded", this.onFioriConfigurationLoaded, this);                                                                                                                          
                                                                                                                                                                                                                                                               
			// Model used to manipulate control states. The chosen values make sure,                                                                                                                                                                                    
			// detail page is busy indication immediately so there is no break in                                                                                                                                                                                       
			// between the busy indication for loading the view's meta data                                                                                                                                                                                             
			var oViewModel = new JSONModel({                                                                                                                                                                                                                            
				busy: false,                                                                                                                                                                                                                                               
				delay: 0,                                                                                                                                                                                                                                                  
				lineItemListTitle: this.getResourceBundle().getText("detailLineItemTableHeading"),                                                                                                                                                                         
				isEditCubiscanDialog: false,                                                                                                                                                                                                                               
				selectedWarehouseNumber: null,                                                                                                                                                                                                                             
				selectedCubiscanDevice: ""                                                                                                                                                                                                                                 
			});                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
			this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched, this);                                                                                                                                                                      
			this.setModel(oViewModel, "detailView");                                                                                                                                                                                                                    
			this.getOwnerComponent().getModel().metadataLoaded().then(this._onMetadataLoaded.bind(this));                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		onExit: function() {                                                                                                                                                                                                                                         
			var oEventBus = sap.ui.getCore().getEventBus();                                                                                                                                                                                                             
			oEventBus.unsubscribe("com.mscg.applications.cubiscan.measure.WarehouseNumber", "Changed", this.onWarehouseNumberChange, this);                                                                                                                             
			oEventBus.unsubscribe("com.mscg.applications.cubiscan.measure.FioriConfiguration", "Loaded", this.onFioriConfigurationLoaded, this);                                                                                                                        
			                                                                                                                                                                                                                                                            
			// Destroy dialogs.                                                                                                                                                                                                                                         
			if (this._oMessagesDialog) {                                                                                                                                                                                                                                
				this._oMessagesDialog.destroy();                                                                                                                                                                                                                           
			}                                                                                                                                                                                                                                                           
			if (this._oCubiscanDialog) {                                                                                                                                                                                                                                
				this._oCubiscanDialog.destroy();                                                                                                                                                                                                                           
			}                                                                                                                                                                                                                                                           
			if (this._oManualEntryDialog) {                                                                                                                                                                                                                             
				this._oManualEntryDialog.destroy();                                                                                                                                                                                                                        
			}                                                                                                                                                                                                                                                           
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/* =========================================================== */                                                                                                                                                                                            
		/* event handlers                                              */                                                                                                                                                                                            
		/* =========================================================== */                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Triggered when the FioriConfiguration model is loaded within the Component.js file.                                                                                                                                                                       
		 * @function                                                                                                                                                                                                                                                 
		 * @param {string} sChannel - the channel for the pub/sub                                                                                                                                                                                                    
		 * @param {string} sEvent - the specific event for the channel                                                                                                                                                                                               
		 * @param {object} oData - the OData object being passed                                                                                                                                                                                                     
		 */                                                                                                                                                                                                                                                          
		onFioriConfigurationLoaded: function(sChannel, sEvent, oData) {                                                                                                                                                                                              
			var oFioriConfigurationModel = this.getOwnerComponent().getModel("fioriConfiguration");                                                                                                                                                                     
			this.byId("manualEntryButton").setVisible(oFioriConfigurationModel.getProperty("/settings/allowManualCreation"));                                                                                                                                           
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Event handler for change of the warehouse number within the master view.                                                                                                                                                                                  
		 * @function                                                                                                                                                                                                                                                 
		 * @param {string} sChannel - the channel for the pub/sub                                                                                                                                                                                                    
		 * @param {string} sEvent - the specific event for the channel                                                                                                                                                                                               
		 * @param {object} oData - the OData object being passed                                                                                                                                                                                                     
		 */                                                                                                                                                                                                                                                          
		onWarehouseNumberChange: function(sChannel, sEvent, oData) {                                                                                                                                                                                                 
			var oViewModel = this.getModel("detailView");                                                                                                                                                                                                               
			oViewModel.setProperty("/selectedWarehouseNumber", oData.warehouseNumber);                                                                                                                                                                                  
			oViewModel.setProperty("/selectedCubiscanDevice", "");                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
			// Rebind the cubiscan device select.                                                                                                                                                                                                                       
			var oCubiscanDeviceInput = this.byId("cubiscanDeviceInput");                                                                                                                                                                                                
			oCubiscanDeviceInput.setModel(this.getOwnerComponent().getModel("cubiscanDevices"));                                                                                                                                                                        
			var filters = new Array();                                                                                                                                                                                                                                  
			filters.push(new sap.ui.model.Filter("warehouseNumber", sap.ui.model.FilterOperator.EQ, oViewModel.getProperty(                                                                                                                                             
				"/selectedWarehouseNumber")));                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
			oCubiscanDeviceInput.bindItems({                                                                                                                                                                                                                            
				path: "/results",                                                                                                                                                                                                                                          
				template: new sap.ui.core.Item({                                                                                                                                                                                                                           
					key: "{deviceName}",                                                                                                                                                                                                                                      
					text: "{deviceDescription}"                                                                                                                                                                                                                               
				}),                                                                                                                                                                                                                                                        
				filters: filters                                                                                                                                                                                                                                           
			});                                                                                                                                                                                                                                                         
			oCubiscanDeviceInput.setSelectedKey();                                                                                                                                                                                                                      
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Triggered if the user triggers the value help request on the product number input within the                                                                                                                                                              
		 * Add Manual Entry dialog.                                                                                                                                                                                                                                  
		 * @function                                                                                                                                                                                                                                                 
		 * @param {object} oEvent                                                                                                                                                                                                                                    
		 */                                                                                                                                                                                                                                                          
		onProductValueHelpRequest: function(oEvent) {                                                                                                                                                                                                                
			var handleClose = function(oEventObj) {                                                                                                                                                                                                                     
				var oSelectedItem = oEventObj.getParameter("selectedItem");                                                                                                                                                                                                
				if (oSelectedItem) {                                                                                                                                                                                                                                       
					this.byId("manualEntryProductNumberInput").setValue(oSelectedItem.getTitle());                                                                                                                                                                            
				}                                                                                                                                                                                                                                                          
			};                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			var handleProductValueHelpSearch = function(oEventObj) {                                                                                                                                                                                                    
				var oViewModel = this.getModel("detailView");                                                                                                                                                                                                              
				var sValue = oEventObj.getParameter("value");                                                                                                                                                                                                              
				var aFilters = [];                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
				aFilters.push(new sap.ui.model.Filter("warehouseNumber", sap.ui.model.FilterOperator.EQ, oViewModel.getProperty(                                                                                                                                           
					"/selectedWarehouseNumber")));                                                                                                                                                                                                                            
				aFilters.push(new sap.ui.model.Filter("product", sap.ui.model.FilterOperator.Contains, sValue));                                                                                                                                                           
				oEventObj.getSource().getBinding("items").filter(aFilters);                                                                                                                                                                                                
			};                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			// Define the filters for use in the binding of the products.                                                                                                                                                                                               
			var aFilters = [];                                                                                                                                                                                                                                          
			var oViewModel = this.getModel("detailView");                                                                                                                                                                                                               
			aFilters.push(new sap.ui.model.Filter("warehouseNumber", sap.ui.model.FilterOperator.EQ, oViewModel.getProperty(                                                                                                                                            
				"/selectedWarehouseNumber")));                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
			var selDialog = new sap.m.SelectDialog({                                                                                                                                                                                                                    
				title: "Products",                                                                                                                                                                                                                                         
				items: {                                                                                                                                                                                                                                                   
					path: "/ProductLookupSet",                                                                                                                                                                                                                                
					template: new sap.m.StandardListItem({                                                                                                                                                                                                                    
						title: "{product}",                                                                                                                                                                                                                                      
						description: "{productDescription}",                                                                                                                                                                                                                     
						active: true                                                                                                                                                                                                                                             
					}),                                                                                                                                                                                                                                                       
					filters: aFilters                                                                                                                                                                                                                                         
				},                                                                                                                                                                                                                                                         
				search: [handleProductValueHelpSearch, this],                                                                                                                                                                                                              
				confirm: [handleClose, this],                                                                                                                                                                                                                              
				cancel: [handleClose, this]                                                                                                                                                                                                                                
			});                                                                                                                                                                                                                                                         
			selDialog.setModel(this.getOwnerComponent().getModel());                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
			// toggle compact style                                                                                                                                                                                                                                     
			jQuery.sap.syncStyleClass("sapUiSizeCompact", this.getView(), selDialog);                                                                                                                                                                                   
			selDialog.open();                                                                                                                                                                                                                                           
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Triggered when the users enters data into the product field on the Add Manual Entry Dialog.                                                                                                                                                               
		 * Creates an inline value help, filters the results.                                                                                                                                                                                                        
		 * @function                                                                                                                                                                                                                                                 
		 * @param {object} oEvent                                                                                                                                                                                                                                    
		 */                                                                                                                                                                                                                                                          
		handleProductSuggestion: function(oEvent) {                                                                                                                                                                                                                  
			var oViewModel = this.getModel("detailView");                                                                                                                                                                                                               
			var sTerm = oEvent.getParameter("suggestValue");                                                                                                                                                                                                            
			var aFilters = [];                                                                                                                                                                                                                                          
			if (sTerm) {                                                                                                                                                                                                                                                
				aFilters.push(new sap.ui.model.Filter("warehouseNumber", sap.ui.model.FilterOperator.EQ, oViewModel.getProperty(                                                                                                                                           
					"/selectedWarehouseNumber")));                                                                                                                                                                                                                            
				aFilters.push(new sap.ui.model.Filter("product", sap.ui.model.FilterOperator.Contains, sTerm.toUpperCase()));                                                                                                                                              
			}                                                                                                                                                                                                                                                           
			oEvent.getSource().getBinding("suggestionItems").filter(aFilters);                                                                                                                                                                                          
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Triggered when the re-binding of data for the UOM select on the Add Manual Entry Dialog completes.                                                                                                                                                        
		 * @function                                                                                                                                                                                                                                                 
		 * @param {object} oEvent                                                                                                                                                                                                                                    
		 */                                                                                                                                                                                                                                                          
		handleUomDataReceived: function(oEvent) {                                                                                                                                                                                                                    
			// If we are validating a product and the UOM dropdown is empty, means that there are no                                                                                                                                                                    
			// UOM's that are currently not in the worklist.                                                                                                                                                                                                            
			if (this._bValidatingProductNumber && oEvent.getSource().getLength() === 0) {                                                                                                                                                                               
				sap.m.MessageBox.error(                                                                                                                                                                                                                                    
					"All configured Cubiscan UOM's already exists in the worklist.", {                                                                                                                                                                                        
						styleClass: "sapUiSizeCompact"                                                                                                                                                                                                                           
					});                                                                                                                                                                                                                                                       
				this.byId("manualEntryProductNumberInput").setValue("");                                                                                                                                                                                                   
				this.byId("manualEntryProductNumberInput").focus();                                                                                                                                                                                                        
			} else {                                                                                                                                                                                                                                                    
				this.byId("manualEntryUomInput").setEnabled(true);                                                                                                                                                                                                         
				this.byId("manualEntrySaveButton").setEnabled(true);                                                                                                                                                                                                       
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			this._bValidatingProductNumber = false;                                                                                                                                                                                                                     
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Triggered when the product is changed in the Add Manual Entry Dialog.                                                                                                                                                                                     
		 * @function                                                                                                                                                                                                                                                 
		 * @param {object} oEvent                                                                                                                                                                                                                                    
		 */                                                                                                                                                                                                                                                          
		handleProductValidation: function(oEvent) {                                                                                                                                                                                                                  
			this._bValidatingProductNumber = true;                                                                                                                                                                                                                      
			var aFilters = [];                                                                                                                                                                                                                                          
			aFilters.push(new sap.ui.model.Filter("product", sap.ui.model.FilterOperator.EQ, oEvent.getSource().getValue()));                                                                                                                                           
                                                                                                                                                                                                                                                               
			var oUomInput = this.byId("manualEntryUomInput");                                                                                                                                                                                                           
			oUomInput.getBinding("items").filter(aFilters);                                                                                                                                                                                                             
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Event handler when the share by E-Mail button has been clicked                                                                                                                                                                                            
		 * @public                                                                                                                                                                                                                                                   
		 */                                                                                                                                                                                                                                                          
		onShareEmailPress: function() {                                                                                                                                                                                                                              
			var oViewModel = this.getModel("detailView");                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
			sap.m.URLHelper.triggerEmail(                                                                                                                                                                                                                               
				null,                                                                                                                                                                                                                                                      
				oViewModel.getProperty("/shareSendEmailSubject"),                                                                                                                                                                                                          
				oViewModel.getProperty("/shareSendEmailMessage")                                                                                                                                                                                                           
			);                                                                                                                                                                                                                                                          
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Event handler when the share in JAM button has been clicked                                                                                                                                                                                               
		 * @public                                                                                                                                                                                                                                                   
		 */                                                                                                                                                                                                                                                          
		onShareInJamPress: function() {                                                                                                                                                                                                                              
			var oViewModel = this.getModel("detailView"),                                                                                                                                                                                                               
				oShareDialog = sap.ui.getCore().createComponent({                                                                                                                                                                                                          
					name: "sap.collaboration.components.fiori.sharing.dialog",                                                                                                                                                                                                
					settings: {                                                                                                                                                                                                                                               
						object: {                                                                                                                                                                                                                                                
							id: location.href,                                                                                                                                                                                                                                      
							share: oViewModel.getProperty("/shareOnJamTitle")                                                                                                                                                                                                       
						}                                                                                                                                                                                                                                                        
					}                                                                                                                                                                                                                                                         
				});                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
			oShareDialog.open();                                                                                                                                                                                                                                        
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Updates the item count within the line item table's header                                                                                                                                                                                                
		 * @param {object} oEvent an event containing the total number of items in the list                                                                                                                                                                          
		 * @private                                                                                                                                                                                                                                                  
		 */                                                                                                                                                                                                                                                          
		onListUpdateFinished: function(oEvent) {                                                                                                                                                                                                                     
			var sTitle,                                                                                                                                                                                                                                                 
				iTotalItems = oEvent.getParameter("total"),                                                                                                                                                                                                                
				oViewModel = this.getModel("detailView");                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
			// only update the counter if the length is final                                                                                                                                                                                                           
			if (this.byId("lineItemsList").getBinding("items").isLengthFinal()) {                                                                                                                                                                                       
				if (iTotalItems) {                                                                                                                                                                                                                                         
					sTitle = this.getResourceBundle().getText("detailLineItemTableHeadingCount", [iTotalItems]);                                                                                                                                                              
				} else {                                                                                                                                                                                                                                                   
					//Display 'Line Items' instead of 'Line items (0)'                                                                                                                                                                                                        
					sTitle = this.getResourceBundle().getText("detailLineItemTableHeading");                                                                                                                                                                                  
				}                                                                                                                                                                                                                                                          
				oViewModel.setProperty("/lineItemListTitle", sTitle);                                                                                                                                                                                                      
			}                                                                                                                                                                                                                                                           
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Displays the manual entry dialog for Manual Entry creation.                                                                                                                                                                                               
		 * @function                                                                                                                                                                                                                                                 
		 * @param {object} oEvent                                                                                                                                                                                                                                    
		 */                                                                                                                                                                                                                                                          
		onManualEntryDialogDisplay: function(oEvent) {                                                                                                                                                                                                               
			var oDialog = this._getManualEntryDialog();                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
			// Need to reset the state of the inputs.                                                                                                                                                                                                                   
			// Clear the product number.                                                                                                                                                                                                                                
			// Disable the UOM and clear all items.                                                                                                                                                                                                                     
			// Disable the save button.                                                                                                                                                                                                                                 
			this.byId("manualEntryProductNumberInput").setValue("");                                                                                                                                                                                                    
			this.byId("manualEntryUomInput").setEnabled(false);                                                                                                                                                                                                         
			this.byId("manualEntryUomInput").destroyItems();                                                                                                                                                                                                            
			this.byId("manualEntrySaveButton").setEnabled(false);                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
			// Add an event handler for the dataReceived event if it does not already exist.                                                                                                                                                                            
			var oBinding = this.byId("manualEntryUomInput").getBinding("items");                                                                                                                                                                                        
			if (!oBinding.hasListeners("dataReceived")) {                                                                                                                                                                                                               
				oBinding.attachEvent("dataReceived", this.handleUomDataReceived, this);                                                                                                                                                                                    
			}                                                                                                                                                                                                                                                           
			oDialog.open();                                                                                                                                                                                                                                             
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		onMessagesDialogClose: function(oEvent) {                                                                                                                                                                                                                    
			this._getMessagesDialog().close();                                                                                                                                                                                                                          
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Triggered when the Close button is clicked on the Manual Entry Dialog.                                                                                                                                                                                    
		 * @function                                                                                                                                                                                                                                                 
		 * @param {object} oEvent                                                                                                                                                                                                                                    
		 */                                                                                                                                                                                                                                                          
		onManualEntryDialogClose: function(oEvent) {                                                                                                                                                                                                                 
			this._closeManualEntryDialog();                                                                                                                                                                                                                             
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		onManualEntryDialogSave: function(oEvent) {                                                                                                                                                                                                                  
			var oModel = this.getModel();                                                                                                                                                                                                                               
			var oViewModel = this.getModel("detailView");                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
			var oObject = {                                                                                                                                                                                                                                             
				"warehouseNumber": oViewModel.getProperty("/selectedWarehouseNumber"),                                                                                                                                                                                     
				"product": this.byId("manualEntryProductNumberInput").getValue(),                                                                                                                                                                                          
				"unitOfMeasure": this.byId("manualEntryUomInput").getSelectedKey(),                                                                                                                                                                                        
				"status": 'N'                                                                                                                                                                                                                                              
			};                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			// Trigger the OData create method.                                                                                                                                                                                                                         
			oModel.create("/WorklistItemSet", oObject, {                                                                                                                                                                                                                
				success: function(oData, oResponse) {                                                                                                                                                                                                                      
					var oMessages = JSON.parse(oResponse.headers["zmscg-messages"]);                                                                                                                                                                                          
					var oJsonModel = new JSONModel(oMessages);                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
					// Display the dialog and bind to the odata model.                                                                                                                                                                                                        
					var oDialog = this._getMessagesDialog();                                                                                                                                                                                                                  
					oDialog.setModel(oJsonModel);                                                                                                                                                                                                                             
					oDialog.open();                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
					// Close the dialog.                                                                                                                                                                                                                                      
					this._closeManualEntryDialog();                                                                                                                                                                                                                           
				}.bind(this),                                                                                                                                                                                                                                              
				error: function(oError) {                                                                                                                                                                                                                                  
					sap.m.MessageBox.error(                                                                                                                                                                                                                                   
						"An error occurred while creating the Worklist record.", {                                                                                                                                                                                               
							styleClass: "sapUiSizeCompact"                                                                                                                                                                                                                          
						});                                                                                                                                                                                                                                                      
				}.bind(this)                                                                                                                                                                                                                                               
			});                                                                                                                                                                                                                                                         
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Looks up the selected object and then displays the screen in the appropriate mode.                                                                                                                                                                        
		 * @function                                                                                                                                                                                                                                                 
		 * @param {object} oEvent                                                                                                                                                                                                                                    
		 */                                                                                                                                                                                                                                                          
		onCubiscanDialogDisplay: function(oEvent) {                                                                                                                                                                                                                  
			var oViewModel = this.getModel("detailView");                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
			// Check if a Cubiscan device is selected first.                                                                                                                                                                                                            
			if (!oViewModel.getProperty("/selectedCubiscanDevice")) {                                                                                                                                                                                                   
				sap.m.MessageBox.error(                                                                                                                                                                                                                                    
					"No Cubiscan device selected.", {                                                                                                                                                                                                                         
						styleClass: "sapUiSizeCompact"                                                                                                                                                                                                                           
					});                                                                                                                                                                                                                                                       
				return;                                                                                                                                                                                                                                                    
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			var sPath = oEvent.getSource().getBindingContext().getPath();                                                                                                                                                                                               
			var oDialog = this._getCubiscanDialog();                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
			// Disable the update button.                                                                                                                                                                                                                               
			this.byId("editUpdateButton").setEnabled(false);                                                                                                                                                                                                            
			                                                                                                                                                                                                                                                            
			// Clear the value state on all inputs.                                                                                                                                                                                                                     
			this.byId("cubiscanLength").setValueState(sap.ui.core.ValueState.None);                                                                                                                                                                                     
			this.byId("cubiscanWidth").setValueState(sap.ui.core.ValueState.None);                                                                                                                                                                                      
			this.byId("cubiscanHeight").setValueState(sap.ui.core.ValueState.None);                                                                                                                                                                                     
			this.byId("cubiscanGrossWeight").setValueState(sap.ui.core.ValueState.None);                                                                                                                                                                                
			this.byId("cubiscanVolume").setValueState(sap.ui.core.ValueState.None);                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
			// Open the WebSocket connection for the Cubiscan.                                                                                                                                                                                                          
			var oFioriConfigModel = this.getOwnerComponent().getModel("fioriConfiguration");                                                                                                                                                                            
			var oWebSocket = new WebSocket("wss://" + oFioriConfigModel.getProperty("/webSocket/hostName") + ":" + oFioriConfigModel.getProperty(                                                                                                                       
				"/webSocket/portNumber") + oFioriConfigModel.getProperty("/webSocket/url"));                                                                                                                                                                               
			oWebSocket.onopen = this._onWebSocketOpen.bind(this);                                                                                                                                                                                                       
			oWebSocket.onmessage = this._onWebSocketMessage.bind(this);                                                                                                                                                                                                 
			oWebSocket.onclose = this._onWebSocketClose.bind(this);                                                                                                                                                                                                     
			oWebSocket.onerror = this._onWebSocketError.bind(this);                                                                                                                                                                                                     
			this._oWebSocket = oWebSocket;                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
			// Bind the dialog and open.                                                                                                                                                                                                                                
			oViewModel.setProperty("/isEditCubiscanDialog", oEvent.getSource().data("editCubiscanDialog"));                                                                                                                                                             
			this._bindDialog(sPath, oDialog);                                                                                                                                                                                                                           
			oDialog.open();                                                                                                                                                                                                                                             
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Triggered when the Close button is clicked on the Cubiscan Details Dialog.                                                                                                                                                                                
		 * @function                                                                                                                                                                                                                                                 
		 * @param {object} oEvent                                                                                                                                                                                                                                    
		 */                                                                                                                                                                                                                                                          
		onCubiscanDialogClose: function(oEvent) {                                                                                                                                                                                                                    
			this._closeCubiscanDialog();                                                                                                                                                                                                                                
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Triggered when the Measure button is clicked on the Cubiscan Details Dialog.                                                                                                                                                                              
		 * Displays the measure "Please Wait" dialog.                                                                                                                                                                                                                
		 * @function                                                                                                                                                                                                                                                 
		 * @param {object} oEvent                                                                                                                                                                                                                                    
		 */                                                                                                                                                                                                                                                          
		onCubiscanDialogMeasure: function(oEvent) {                                                                                                                                                                                                                  
			this._getCubiscanDialog().setVisible(false);                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
			var oBusyDialog = this.getView().byId("measureBusyDialog");                                                                                                                                                                                                 
			oBusyDialog.setVisible(true).open();                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
			// Trigger a call over the websocket.  This will start polling by the                                                                                                                                                                                       
			// appropriate client implementation.                                                                                                                                                                                                                       
			// Is the websocket connection open?                                                                                                                                                                                                                        
			if (this._oWebSocket.readyState === 1) {                                                                                                                                                                                                                    
				// Yup, let's do this...                                                                                                                                                                                                                                   
				var oViewModel = this.getModel("detailView");                                                                                                                                                                                                              
				var oObject = oEvent.getSource().getBindingContext().getObject();                                                                                                                                                                                          
				var oRequestObject = {                                                                                                                                                                                                                                     
					warehouseNumber: oObject.warehouseNumber,                                                                                                                                                                                                                 
					deviceName: oViewModel.getProperty("/selectedCubiscanDevice"),                                                                                                                                                                                            
					product: oObject.product,                                                                                                                                                                                                                                 
					uom: oObject.unitOfMeasure                                                                                                                                                                                                                                
				};                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
				this._oWebSocket.send(JSON.stringify(oRequestObject));                                                                                                                                                                                                     
			} else {                                                                                                                                                                                                                                                    
				// Should show a message indicating that the websocket is closed.                                                                                                                                                                                          
				sap.m.MessageBox.error(                                                                                                                                                                                                                                    
					"An error occurred, the connection to the Cubiscan device appears to be closed.", {                                                                                                                                                                       
						styleClass: "sapUiSizeCompact"                                                                                                                                                                                                                           
					});                                                                                                                                                                                                                                                       
			}                                                                                                                                                                                                                                                           
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Triggered when the Update button is clicked on the Cubiscan Details Dialog.                                                                                                                                                                               
		 * @param {object} oEvent                                                                                                                                                                                                                                    
		 */                                                                                                                                                                                                                                                          
		onCubiscanDialogUpdate: function(oEvent) {                                                                                                                                                                                                                   
			var oModel = this.getModel();                                                                                                                                                                                                                               
			var oBindingContext = oEvent.getSource().getBindingContext();                                                                                                                                                                                               
			var sPath = oBindingContext.getPath();                                                                                                                                                                                                                      
			var oObject = oBindingContext.getObject();                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
			// Update the object.                                                                                                                                                                                                                                       
			oObject.status = "S";                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
			// Delete the productData so that we can update.  Hack but it works I guess...                                                                                                                                                                              
			delete oObject.productData;                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
			// Trigger the OData update method.                                                                                                                                                                                                                         
			oModel.update(sPath, oObject, {                                                                                                                                                                                                                             
				success: function() {                                                                                                                                                                                                                                      
					sap.m.MessageToast.show("Worklist item updated successfully.");                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
					// Close the dialog.                                                                                                                                                                                                                                      
					this._closeCubiscanDialog();                                                                                                                                                                                                                              
				}.bind(this),                                                                                                                                                                                                                                              
				error: function() {                                                                                                                                                                                                                                        
					sap.m.MessageBox.error(                                                                                                                                                                                                                                   
						"An error occurred while updating the Worklist record.", {                                                                                                                                                                                               
							styleClass: "sapUiSizeCompact"                                                                                                                                                                                                                          
						});                                                                                                                                                                                                                                                      
				}.bind(this)                                                                                                                                                                                                                                               
			});                                                                                                                                                                                                                                                         
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Triggered when the Discrepancy button is clicked on the Cubiscan Details Dialog.                                                                                                                                                                          
		 * @function                                                                                                                                                                                                                                                 
		 * @param {object} oEvent                                                                                                                                                                                                                                    
		 */                                                                                                                                                                                                                                                          
		onCubiscanDialogDiscrepancy: function(oEvent) {                                                                                                                                                                                                              
			var oModel = this.getModel();                                                                                                                                                                                                                               
			var oBindingContext = oEvent.getSource().getBindingContext();                                                                                                                                                                                               
			var sPath = oBindingContext.getPath();                                                                                                                                                                                                                      
			var oObject = oBindingContext.getObject();                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
			// Update the object.                                                                                                                                                                                                                                       
			oObject.worklistCategory = "INT";                                                                                                                                                                                                                           
			oObject.status = "R";                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
			// Delete the productData so that we can update.  Hack but it works I guess...                                                                                                                                                                              
			delete oObject.productData;                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
			// Trigger the OData update method.                                                                                                                                                                                                                         
			oModel.update(sPath, oObject, {                                                                                                                                                                                                                             
				success: function() {                                                                                                                                                                                                                                      
					sap.m.MessageToast.show("Worklist item updated successfully.");                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
					// Close the dialog.                                                                                                                                                                                                                                      
					this._closeCubiscanDialog();                                                                                                                                                                                                                              
				}.bind(this),                                                                                                                                                                                                                                              
				error: function() {                                                                                                                                                                                                                                        
					sap.m.MessageBox.error(                                                                                                                                                                                                                                   
						"An error occurred while updating the Worklist record.", {                                                                                                                                                                                               
							styleClass: "sapUiSizeCompact"                                                                                                                                                                                                                          
						});                                                                                                                                                                                                                                                      
				}.bind(this)                                                                                                                                                                                                                                               
			});                                                                                                                                                                                                                                                         
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Triggered when the Cancel button is clicked on the Cubiscan Busy Dialog.                                                                                                                                                                                  
		 * @function                                                                                                                                                                                                                                                 
		 * @param {object} oEvent                                                                                                                                                                                                                                    
		 */                                                                                                                                                                                                                                                          
		onMeasureBusyDialogClose: function(oEvent) {                                                                                                                                                                                                                 
			// Redisply the dialog.                                                                                                                                                                                                                                     
			this._getCubiscanDialog().setVisible(true);                                                                                                                                                                                                                 
			var userClosed = oEvent.getParameter("cancelPressed");                                                                                                                                                                                                      
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Factory method for worklist item rendering.  Called for each line in the worklist items rendering.                                                                                                                                                        
		 *&nbsp;                                                                                                                                                                                                                                                     
		 * @function                                                                                                                                                                                                                                                 
		 * @param {String} sId id of the parent control                                                                                                                                                                                                              
		 * @param {sap.ui.model.ContextBinding} oContext context binding object, data essentially                                                                                                                                                                    
		 * @return {sap.m.ColumnListItem} a ColumnListItem object                                                                                                                                                                                                    
		 */                                                                                                                                                                                                                                                          
		worklistItemsFactory: function(sId, oContext) {                                                                                                                                                                                                              
			// Get the status, if the status is "N" then we need to make sure the Dimension button is enabled.                                                                                                                                                          
			var sStatus = oContext.getProperty("status");                                                                                                                                                                                                               
			var sStatusText = oContext.getProperty("statusText");                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
			var oButtonsContainer = new sap.m.HBox();                                                                                                                                                                                                                   
			oButtonsContainer.addItem(new sap.m.Button({                                                                                                                                                                                                                
				icon: "sap-icon://dimension",                                                                                                                                                                                                                              
				tooltip: "Dimension Product",                                                                                                                                                                                                                              
				press: [this.onCubiscanDialogDisplay, this],                                                                                                                                                                                                               
				enabled: (sStatus === "N") ? true : false,                                                                                                                                                                                                                 
				customData: {                                                                                                                                                                                                                                              
					Type: "sap.ui.core.CustomData",                                                                                                                                                                                                                           
					key: "editCubiscanDialog",                                                                                                                                                                                                                                
					value: true                                                                                                                                                                                                                                               
				}                                                                                                                                                                                                                                                          
			}));                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
			oButtonsContainer.addItem(new sap.m.Button({                                                                                                                                                                                                                
				icon: "sap-icon://detail-view",                                                                                                                                                                                                                            
				tooltip: "Show Details",                                                                                                                                                                                                                                   
				press: [this.onCubiscanDialogDisplay, this],                                                                                                                                                                                                               
				customData: {                                                                                                                                                                                                                                              
					Type: "sap.ui.core.CustomData",                                                                                                                                                                                                                           
					key: "editCubiscanDialog",                                                                                                                                                                                                                                
					value: false                                                                                                                                                                                                                                              
				}                                                                                                                                                                                                                                                          
			}));                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
			var row = new sap.m.ColumnListItem(sId, {                                                                                                                                                                                                                   
				type: "Active",                                                                                                                                                                                                                                            
				cells: [                                                                                                                                                                                                                                                   
					new sap.m.ObjectIdentifier({                                                                                                                                                                                                                              
						title: "{unitOfMeasure}"                                                                                                                                                                                                                                 
					}),                                                                                                                                                                                                                                                       
					new sap.m.Text({                                                                                                                                                                                                                                          
						text: sStatusText                                                                                                                                                                                                                                        
					}),                                                                                                                                                                                                                                                       
					oButtonsContainer                                                                                                                                                                                                                                         
				]                                                                                                                                                                                                                                                          
			});                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
			return row;                                                                                                                                                                                                                                                 
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/* =========================================================== */                                                                                                                                                                                            
		/* begin: internal methods                                     */                                                                                                                                                                                            
		/* =========================================================== */                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Returns the Messages dialog and if it is not already created, creates it and returns a reference.                                                                                                                                                         
		 * @function                                                                                                                                                                                                                                                 
		 * @return {sap.m.Dialog} returns an instance of the dialog                                                                                                                                                                                                  
		 * @private                                                                                                                                                                                                                                                  
		 */                                                                                                                                                                                                                                                          
		_getMessagesDialog: function() {                                                                                                                                                                                                                             
			// create dialog lazily                                                                                                                                                                                                                                     
			if (!this._oMessagesDialog) {                                                                                                                                                                                                                               
				// create dialog via fragment factory                                                                                                                                                                                                                      
				this._oMessagesDialog = sap.ui.xmlfragment(this.getView().getId(),                                                                                                                                                                                         
					"com.mscg.applications.cubiscan.measure.view.MessageDialog", this);                                                                                                                                                                                       
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			return this._oMessagesDialog;                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Returns the Cubiscan dialog and if it is not already created, creates it and returns a reference.                                                                                                                                                         
		 * @function                                                                                                                                                                                                                                                 
		 * @return {sap.m.Dialog} returns an instance of the dialog                                                                                                                                                                                                  
		 * @private                                                                                                                                                                                                                                                  
		 */                                                                                                                                                                                                                                                          
		_getCubiscanDialog: function() {                                                                                                                                                                                                                             
			// create dialog lazily                                                                                                                                                                                                                                     
			if (!this._oCubiscanDialog) {                                                                                                                                                                                                                               
				// create dialog via fragment factory                                                                                                                                                                                                                      
				this._oCubiscanDialog = sap.ui.xmlfragment(this.getView().getId(),                                                                                                                                                                                         
					"com.mscg.applications.cubiscan.measure.view.MeasurementDetailsDialog", this);                                                                                                                                                                            
				this.getView().addDependent(this._oCubiscanDialog);                                                                                                                                                                                                        
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			return this._oCubiscanDialog;                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Closes the Cubiscan details dialog.                                                                                                                                                                                                                       
		 * @function                                                                                                                                                                                                                                                 
		 * @private                                                                                                                                                                                                                                                  
		 */                                                                                                                                                                                                                                                          
		_closeCubiscanDialog: function() {                                                                                                                                                                                                                           
			this._oWebSocket.close();                                                                                                                                                                                                                                   
			this._oWebSocket = null;                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
			this._getCubiscanDialog().close();                                                                                                                                                                                                                          
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Binds the product data to the dialog object.  Once the data is bound, it opens the dialog window.                                                                                                                                                         
		 * @function                                                                                                                                                                                                                                                 
		 * @param {string} sPath binding path                                                                                                                                                                                                                        
		 * @param {sap.m.Dialog} oDialog dialog to bind the data too                                                                                                                                                                                                 
		 * @private                                                                                                                                                                                                                                                  
		 */                                                                                                                                                                                                                                                          
		_bindDialog: function(sPath, oDialog) {                                                                                                                                                                                                                      
			// Set busy indicator during view binding                                                                                                                                                                                                                   
			var oViewModel = this.getModel("detailView");                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
			// If the view was not bound yet its not busy, only if the binding requests data it is set to busy again                                                                                                                                                    
			oViewModel.setProperty("/busy", false);                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
			oDialog.bindElement({                                                                                                                                                                                                                                       
				path: sPath,                                                                                                                                                                                                                                               
				parameters: {                                                                                                                                                                                                                                              
					"expand": "productData"                                                                                                                                                                                                                                   
				},                                                                                                                                                                                                                                                         
				events: {                                                                                                                                                                                                                                                  
					dataRequested: function() {                                                                                                                                                                                                                               
						oViewModel.setProperty("/busy", true);                                                                                                                                                                                                                   
					},                                                                                                                                                                                                                                                        
					dataReceived: function() {                                                                                                                                                                                                                                
						oViewModel.setProperty("/busy", false);                                                                                                                                                                                                                  
					}                                                                                                                                                                                                                                                         
				}                                                                                                                                                                                                                                                          
			});                                                                                                                                                                                                                                                         
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Returns the Manual Entry dialog and if it is not already created, creates it and returns a reference.                                                                                                                                                     
		 * @function                                                                                                                                                                                                                                                 
		 * @return {sap.m.Dialog} returns an instance of the dialog                                                                                                                                                                                                  
		 * @private                                                                                                                                                                                                                                                  
		 */                                                                                                                                                                                                                                                          
		_getManualEntryDialog: function() {                                                                                                                                                                                                                          
			// create dialog lazily                                                                                                                                                                                                                                     
			if (!this._oManualEntryDialog) {                                                                                                                                                                                                                            
				// create dialog via fragment factory                                                                                                                                                                                                                      
				this._oManualEntryDialog = sap.ui.xmlfragment(this.getView().getId(),                                                                                                                                                                                      
					"com.mscg.applications.cubiscan.measure.view.ManualEntryDialog", this);                                                                                                                                                                                   
				this.getView().addDependent(this._oManualEntryDialog);                                                                                                                                                                                                     
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			return this._oManualEntryDialog;                                                                                                                                                                                                                            
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Closes the Manual Entry dialog.                                                                                                                                                                                                                           
		 * @function                                                                                                                                                                                                                                                 
		 * @private                                                                                                                                                                                                                                                  
		 */                                                                                                                                                                                                                                                          
		_closeManualEntryDialog: function() {                                                                                                                                                                                                                        
			this._getManualEntryDialog().close();                                                                                                                                                                                                                       
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Binds the view to the object path and expands the aggregated line items.                                                                                                                                                                                  
		 * @function                                                                                                                                                                                                                                                 
		 * @param {sap.ui.base.Event} oEvent pattern match event in route 'object'                                                                                                                                                                                   
		 * @private                                                                                                                                                                                                                                                  
		 */                                                                                                                                                                                                                                                          
		_onObjectMatched: function(oEvent) {                                                                                                                                                                                                                         
			var oArguments = oEvent.getParameter("arguments");                                                                                                                                                                                                          
			var warehouse = oArguments.warehouse;                                                                                                                                                                                                                       
			var product = oArguments.product;                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			this.getModel().metadataLoaded().then(function() {                                                                                                                                                                                                          
				var sObjectPath = this.getModel().createKey("WorklistHeaderSet", {                                                                                                                                                                                         
					warehouseNumber: warehouse,                                                                                                                                                                                                                               
					product: product                                                                                                                                                                                                                                          
				});                                                                                                                                                                                                                                                        
				this._bindView("/" + sObjectPath);                                                                                                                                                                                                                         
			}.bind(this));                                                                                                                                                                                                                                              
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Binds the view to the object path. Makes sure that detail view displays                                                                                                                                                                                   
		 * a busy indicator while data for the corresponding element binding is loaded.                                                                                                                                                                              
		 * @function                                                                                                                                                                                                                                                 
		 * @param {string} sObjectPath path to the object to be bound to the view.                                                                                                                                                                                   
		 * @private                                                                                                                                                                                                                                                  
		 */                                                                                                                                                                                                                                                          
		_bindView: function(sObjectPath) {                                                                                                                                                                                                                           
			// Set busy indicator during view binding                                                                                                                                                                                                                   
			var oViewModel = this.getModel("detailView");                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
			// If the view was not bound yet its not busy, only if the binding requests data it is set to busy again                                                                                                                                                    
			oViewModel.setProperty("/busy", false);                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
			this.getView().bindElement({                                                                                                                                                                                                                                
				path: sObjectPath,                                                                                                                                                                                                                                         
				events: {                                                                                                                                                                                                                                                  
					change: this._onBindingChange.bind(this),                                                                                                                                                                                                                 
					dataRequested: function() {                                                                                                                                                                                                                               
						oViewModel.setProperty("/busy", true);                                                                                                                                                                                                                   
					},                                                                                                                                                                                                                                                        
					dataReceived: function() {                                                                                                                                                                                                                                
						oViewModel.setProperty("/busy", false);                                                                                                                                                                                                                  
					}                                                                                                                                                                                                                                                         
				}                                                                                                                                                                                                                                                          
			});                                                                                                                                                                                                                                                         
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		_onBindingChange: function() {                                                                                                                                                                                                                               
			var oView = this.getView(),                                                                                                                                                                                                                                 
				oElementBinding = oView.getElementBinding();                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
			// No data for the binding                                                                                                                                                                                                                                  
			if (!oElementBinding.getBoundContext()) {                                                                                                                                                                                                                   
				this.getRouter().getTargets().display("detailObjectNotFound");                                                                                                                                                                                             
				// if object could not be found, the selection in the master list                                                                                                                                                                                          
				// does not make sense anymore.                                                                                                                                                                                                                            
				this.getOwnerComponent().oListSelector.clearMasterListSelection();                                                                                                                                                                                         
				return;                                                                                                                                                                                                                                                    
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			var sPath = oElementBinding.getPath(),                                                                                                                                                                                                                      
				oResourceBundle = this.getResourceBundle(),                                                                                                                                                                                                                
				oObject = oView.getModel().getObject(sPath),                                                                                                                                                                                                               
				sObjectId = oObject.product,                                                                                                                                                                                                                               
				sObjectName = oObject.product,                                                                                                                                                                                                                             
				oViewModel = this.getModel("detailView");                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
			oViewModel.setProperty("/saveAsTileTitle", oResourceBundle.getText("shareSaveTileAppTitle", [sObjectName]));                                                                                                                                                
			oViewModel.setProperty("/shareOnJamTitle", sObjectName);                                                                                                                                                                                                    
			oViewModel.setProperty("/shareSendEmailSubject",                                                                                                                                                                                                            
				oResourceBundle.getText("shareSendEmailObjectSubject", [sObjectId]));                                                                                                                                                                                      
			oViewModel.setProperty("/shareSendEmailMessage",                                                                                                                                                                                                            
				oResourceBundle.getText("shareSendEmailObjectMessage", [sObjectName, sObjectId, location.href]));                                                                                                                                                          
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		_onMetadataLoaded: function() {                                                                                                                                                                                                                              
			// Store original busy indicator delay for the detail view                                                                                                                                                                                                  
			var iOriginalViewBusyDelay = this.getView().getBusyIndicatorDelay(),                                                                                                                                                                                        
				oViewModel = this.getModel("detailView"),                                                                                                                                                                                                                  
				oLineItemTable = this.byId("lineItemsList"),                                                                                                                                                                                                               
				iOriginalLineItemTableBusyDelay = oLineItemTable.getBusyIndicatorDelay();                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
			// Make sure busy indicator is displayed immediately when                                                                                                                                                                                                   
			// detail view is displayed for the first time                                                                                                                                                                                                              
			oViewModel.setProperty("/delay", 0);                                                                                                                                                                                                                        
			oViewModel.setProperty("/lineItemTableDelay", 0);                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			oLineItemTable.attachEventOnce("updateFinished", function() {                                                                                                                                                                                               
				// Restore original busy indicator delay for line item table                                                                                                                                                                                               
				oViewModel.setProperty("/lineItemTableDelay", iOriginalLineItemTableBusyDelay);                                                                                                                                                                            
			});                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
			// Binding the view will set it to not busy - so the view is always busy if it is not bound                                                                                                                                                                 
			oViewModel.setProperty("/busy", true);                                                                                                                                                                                                                      
			// Restore original busy indicator delay for the detail view                                                                                                                                                                                                
			oViewModel.setProperty("/delay", iOriginalViewBusyDelay);                                                                                                                                                                                                   
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		//**********************************************************************************************                                                                                                                                                             
		// Web socket handler methods.                                                                                                                                                                                                                               
		//**********************************************************************************************                                                                                                                                                             
		/**                                                                                                                                                                                                                                                          
		 * Handler method for when the web socket receives a message.                                                                                                                                                                                                
		 * @function                                                                                                                                                                                                                                                 
		 * @param {object} oEvent, event object that contains the event information including the message.                                                                                                                                                           
		 * @private                                                                                                                                                                                                                                                  
		 */                                                                                                                                                                                                                                                          
		_onWebSocketMessage: function(oEvent) {                                                                                                                                                                                                                      
			// Process received Message                                                                                                                                                                                                                                 
			var oResponse = JSON.parse(oEvent.data);                                                                                                                                                                                                                    
			var oViewModel = this.getModel("detailView");                                                                                                                                                                                                               
			var sWarehouseNumber = oViewModel.getProperty("/selectedWarehouseNumber");                                                                                                                                                                                  
			var sDeviceName = oViewModel.getProperty("/selectedCubiscanDevice");                                                                                                                                                                                        
			var oBusyDialog = this.getView().byId("measureBusyDialog");                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
			// Validate that the message is destined for this instance.  Same warehouse number and cubiscan device...                                                                                                                                                   
			if (oResponse.warehouseNumber === sWarehouseNumber && oResponse.deviceName === sDeviceName) {                                                                                                                                                               
				switch (oResponse.action) {                                                                                                                                                                                                                                
					case "success":                                                                                                                                                                                                                                           
						this._handleCubiscanWebsocketMessage(oResponse);                                                                                                                                                                                                         
						break;                                                                                                                                                                                                                                                   
					case "timeout":                                                                                                                                                                                                                                           
						sap.m.MessageBox.information(                                                                                                                                                                                                                            
							"Timeout occured while waiting to receive scan data from the Cubiscan device.", {                                                                                                                                                                       
								styleClass: "sapUiSizeCompact"                                                                                                                                                                                                                         
							});                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
						// Close the busy dialog and show the details dialog.                                                                                                                                                                                                    
						oBusyDialog.setVisible(false).close();                                                                                                                                                                                                                   
						this._getCubiscanDialog().setVisible(true);                                                                                                                                                                                                              
						break;                                                                                                                                                                                                                                                   
					case "connectError":                                                                                                                                                                                                                                      
						sap.m.MessageBox.error(                                                                                                                                                                                                                                  
							"Error occurred while trying to establish a connection with the Cubiscan device.", {                                                                                                                                                                    
								styleClass: "sapUiSizeCompact"                                                                                                                                                                                                                         
							});                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
						// Close the busy dialog and show the details dialog.                                                                                                                                                                                                    
						oBusyDialog.setVisible(false).close();                                                                                                                                                                                                                   
						this._getCubiscanDialog().setVisible(true);                                                                                                                                                                                                              
						break;                                                                                                                                                                                                                                                   
				}                                                                                                                                                                                                                                                          
			}                                                                                                                                                                                                                                                           
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Handler method for the onopen event on the websocket.  Used to do any setup once the websocket is open.                                                                                                                                                   
		 * @function                                                                                                                                                                                                                                                 
		 * @param {object} oEvent                                                                                                                                                                                                                                    
		 * @private                                                                                                                                                                                                                                                  
		 */                                                                                                                                                                                                                                                          
		_onWebSocketOpen: function(oEvent) {                                                                                                                                                                                                                         
			// Handle anything you want to do upon opening the websocket connection.                                                                                                                                                                                    
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Handler method for the onclose event on the websocket.  Used to do any cleanup, etc. when the websocket is closed.                                                                                                                                        
		 * @function                                                                                                                                                                                                                                                 
		 * @param {object} oEvent                                                                                                                                                                                                                                    
		 * @private                                                                                                                                                                                                                                                  
		 */                                                                                                                                                                                                                                                          
		_onWebSocketClose: function(oEvent) {                                                                                                                                                                                                                        
			// Handle anything you want to do upon closing the websocket connection.                                                                                                                                                                                    
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Handler method for the error event.  Used to process any error handling.                                                                                                                                                                                  
		 * @function                                                                                                                                                                                                                                                 
		 * @param {object} oEvent                                                                                                                                                                                                                                    
		 * @private                                                                                                                                                                                                                                                  
		 */                                                                                                                                                                                                                                                          
		_onWebSocketError: function(oEvent) {                                                                                                                                                                                                                        
			sap.m.MessageBox.warning(                                                                                                                                                                                                                                   
				"Websocket connection failed.", {                                                                                                                                                                                                                          
					styleClass: "sapUiSizeCompact"                                                                                                                                                                                                                            
				});                                                                                                                                                                                                                                                        
		},                                                                                                                                                                                                                                                           
		                                                                                                                                                                                                                                                             
		_determineValueState: function(iStatus){                                                                                                                                                                                                                     
			if(iStatus === 1){                                                                                                                                                                                                                                          
				return sap.ui.core.ValueState.Sucess;                                                                                                                                                                                                                      
			}else if(iStatus === 2){                                                                                                                                                                                                                                    
				return sap.ui.core.ValueState.Warning;                                                                                                                                                                                                                     
			}else if(iStatus === 3){                                                                                                                                                                                                                                    
				return sap.ui.core.ValueState.Error;                                                                                                                                                                                                                       
			}                                                                                                                                                                                                                                                           
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Handle the cubiscan response message.  Populate the data into the screen and hide the waiting dialog.                                                                                                                                                     
		 * @function                                                                                                                                                                                                                                                 
		 * @param {object} oMessage JSON object containing the message contents                                                                                                                                                                                      
		 * @private                                                                                                                                                                                                                                                  
		 */                                                                                                                                                                                                                                                          
		_handleCubiscanWebsocketMessage: function(oMessage) {                                                                                                                                                                                                        
			// Refresh the binding to get the newest data.                                                                                                                                                                                                              
			var oDialog = this._getCubiscanDialog();                                                                                                                                                                                                                    
			oDialog.getElementBinding().refresh();                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
			// Enable the update button.                                                                                                                                                                                                                                
			this.byId("editUpdateButton").setEnabled(true);                                                                                                                                                                                                             
			                                                                                                                                                                                                                                                            
			// Update the value states.                                                                                                                                                                                                                                 
			this.byId("cubiscanLength").setValueState(this._determineValueState(oMessage.lengthStatus));                                                                                                                                                                
			this.byId("cubiscanWidth").setValueState(this._determineValueState(oMessage.widthStatus));                                                                                                                                                                  
			this.byId("cubiscanHeight").setValueState(this._determineValueState(oMessage.heightStatus));                                                                                                                                                                
			this.byId("cubiscanGrossWeight").setValueState(this._determineValueState(oMessage.grossWeightStatus));                                                                                                                                                      
			this.byId("cubiscanVolume").setValueState(this._determineValueState(oMessage.volumeStatus));                                                                                                                                                                
                                                                                                                                                                                                                                                               
			// Close the busy dialog and show the details dialog.                                                                                                                                                                                                       
			var oBusyDialog = this.getView().byId("measureBusyDialog");                                                                                                                                                                                                 
			oBusyDialog.setVisible(false).close();                                                                                                                                                                                                                      
			this._getCubiscanDialog().setVisible(true);                                                                                                                                                                                                                 
		}                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
		//**********************************************************************************************                                                                                                                                                             
		//**********************************************************************************************                                                                                                                                                             
	});                                                                                                                                                                                                                                                           
});                                                                                                                                                                                                                                                            